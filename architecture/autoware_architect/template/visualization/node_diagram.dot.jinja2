// Autogenerated Graphviz DOT template for system diagram
// Mirrors the structure of node_diagram.puml.jinja2
// Variables provided by deployment visualization context:
//  name: deployment / system name
//  children: top-level instances (modules or nodes)
//  links: cross-instance links (each has from_port, to_port)
// Entity model (simplified):
//  instance.entity_type in {"module", "node"}
//  instance.unique_id, instance.name, instance.children, instance.links
//  instance.in_ports / out_ports -> port.unique_id, port.name, port.is_global, port.topic(list), port.msg_type, port.event.{frequency,warn_rate,error_rate}
// Styling aims for readable left-to-right flow with clusters per module/node.

digraph "{{ name }}" {
	graph [
		rankdir=LR;
		fontsize=10;
		labelloc=t;
		label=<<B>System Diagram {{ name }}</B>>;
		splines=true;
		pad="0.3";
		nodesep="0.35";
		ranksep="0.6";
	];
	node [
		fontname="Helvetica";
		fontsize=9;
		shape=box;
	];
	edge [
		fontname="Helvetica";
		fontsize=7;
		color="#333355";
		arrowsize=0.6;
	];

	// Common shapes styling
	// port nodes
	subgraph cluster_legend { label="Legend"; fontsize=8; labelloc=b; style=dashed; color="#cccccc";
		legend_in [label="in port", shape=ellipse, style=filled, fillcolor="#e0f7ff"];
		legend_out [label="out port", shape=ellipse, style=filled, fillcolor="#fff4e0"];
		legend_topic [label="global topic", shape=oval, style=filled, fillcolor="#dddddd"];
		legend_in -> legend_out [label="flow"];
	}

	{% macro port_label(port, direction) -%}
		{{ direction }}/{{ port.name }}\n@{{ port.event.frequency }} Hz
	{%- endmacro %}

	{% macro topic_label(port) -%}
		/{{ port.topic | join('/') }}\n{{ port.msg_type }}\n@{{ port.event.frequency }} Hz\nw:{{ port.event.warn_rate }}Hz e:{{ port.event.error_rate }}s
	{%- endmacro %}

	{% macro build_instance_graph(instance) %}
		{% if instance.entity_type == 'module' %}
			subgraph cluster_{{ instance.unique_id }} {
				label="MODULE: {{ instance.name }}";
				style=rounded; color="#8888aa"; penwidth=1.2; fontsize=10;
				// module ports
				{% for p in instance.in_ports %}
					{{ p.unique_id }} [label="{{ port_label(p, 'input') }}", shape=ellipse, style=filled, fillcolor="#e0f7ff"];
				{% endfor %}
				{% for p in instance.out_ports %}
					{{ p.unique_id }} [label="{{ port_label(p, 'output') }}", shape=ellipse, style=filled, fillcolor="#fff4e0"];
				{% endfor %}
				// children
				{% for child in instance.children %}
					{{ build_instance_graph(child) }}
				{% endfor %}
				// internal links
				{% for link in instance.links %}
					{{ link.from_port.unique_id }} -> {{ link.to_port.unique_id }} [color="#555577"];
				{% endfor %}
			}
		{% elif instance.entity_type == 'node' %}
			subgraph cluster_{{ instance.unique_id }} {
				label="NODE: {{ instance.name }}";
				style=rounded; color="#6699aa"; penwidth=1.0; fontsize=9; fillcolor="#f8f8f8"; bgcolor="#f8f8f8";
				{% for p in instance.in_ports %}
					{{ p.unique_id }} [label="{{ port_label(p, 'input') }}", shape=ellipse, style=filled, fillcolor="#e0f7ff"];
				{% endfor %}
				{% for p in instance.out_ports %}
					{{ p.unique_id }} [label="{{ port_label(p, 'output') }}", shape=ellipse, style=filled, fillcolor="#fff4e0"];
				{% endfor %}
				// local (non-global) output topic notes
				{% for p in instance.out_ports %}
					{% if not p.is_global %}
						{{ p.unique_id }}_topic [label="{{ topic_label(p) }}", shape=note, fontsize=7, color="#bbbbbb", style=filled, fillcolor="#f2f2f2"];
						{{ p.unique_id }} -> {{ p.unique_id }}_topic [style=dashed, arrowhead=none];
					{% endif %}
				{% endfor %}
			}
			// global output topics outside node cluster
			{% for p in instance.out_ports %}
				{% if p.is_global %}
					{{ p.unique_id }}_topic [label="/{{ p.topic | join('/') }}\n@{{ p.event.frequency }}Hz", shape=oval, style=filled, fillcolor="#dddddd", fontsize=8];
					{{ p.unique_id }} -> {{ p.unique_id }}_topic [penwidth=1.2];
				{% endif %}
			{% endfor %}
			// global input topics feeding into ports
			{% for p in instance.in_ports %}
				{% if p.is_global %}
					{{ p.unique_id }}_topic [label="/{{ p.topic | join('/') }}", shape=oval, style=filled, fillcolor="#dddddd", fontsize=8];
					{{ p.unique_id }}_topic -> {{ p.unique_id }} [penwidth=1.0, style=solid];
				{% endif %}
			{% endfor %}
		{% endif %}
	{% endmacro %}

	// Top-level children clusters
	{% for child in children %}
		{{ build_instance_graph(child) }}
	{% endfor %}

	// Cross-instance links (already included in module internal links, but top-level may add more)
	{% for link in links %}
		{{ link.from_port.unique_id }} -> {{ link.to_port.unique_id }};
	{% endfor %}

	// Hidden edges to stabilize layout horizontally
	{% for i in range(children|length) %}
		{% for j in range(i + 1, children|length) %}
			{{ children[i].unique_id }} -> {{ children[j].unique_id }} [style=invis, weight=0];
		{% endfor %}
	{% endfor %}
}
