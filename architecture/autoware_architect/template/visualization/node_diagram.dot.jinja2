// Autogenerated Graphviz DOT template for system diagram
// Mirrors the structure of node_diagram.puml.jinja2
// Variables provided by deployment visualization context:
//  name: deployment / system name
//  children: top-level instances (modules or nodes)
//  links: cross-instance links (each has from_port, to_port)
// Entity model (simplified):
//  instance.entity_type in {"module", "node"}
//  instance.unique_id, instance.name, instance.children, instance.links
//  instance.in_ports / out_ports -> port.unique_id, port.name, port.is_global, port.topic(list), port.msg_type, port.event.{frequency,warn_rate,error_rate}
// Styling aims for readable left-to-right flow with clusters per module/node.

digraph "{{ name }}" {
	graph [
		rankdir=LR;
		fontsize=10;
		fontname="Arial";
		labelloc=t;
		label=<<B>System Diagram {{ name }}</B>>;
		splines=true;
		pad="0.3";
		nodesep="0.35";
		ranksep="0.6";
	];
	node [
		fontname="Arial";
		fontsize=9;
		shape=box;
	];
	edge [
		fontname="Arial";
		fontsize=7;
		color="#333355";
		arrowsize=0.6;
	];

	// Common shapes styling
	// port nodes
	subgraph cluster_legend { label="Legend"; fontsize=8; labelloc=b; style=dashed; color="#cccccc";
		legend_module_in [label="module in port", shape=ellipse, style=filled, fillcolor="#e0f7ff"];
		legend_module_out [label="module out port", shape=ellipse, style=filled, fillcolor="#fff4e0"];
		legend_node_in [label="node in port", shape=box, style=filled, fillcolor="#e0f7ff"];
		legend_node_out [label="node out port", shape=box, style=filled, fillcolor="#fff4e0"];
		legend_global_topic [label="global topic", shape=oval, style=filled, fillcolor="#dddddd"];
		legend_node_out -> legend_module_out [arrowhead=normal, style=solid];
		legend_module_out -> legend_module_in [arrowhead=normal, style=solid];
		legend_module_in -> legend_node_in [arrowhead=normal, style=solid];
	}

	{% macro node_in_port_label(port, direction) -%}
		{{ direction }}/{{ port.name }}\n@{{ port.event.frequency }} Hz
	{%- endmacro %}
	{% macro node_out_port_label(port, direction) -%}
		{{ direction }}/{{ port.name }}\n/{{ port.topic | join('/') }}\n{{ port.msg_type }}\n@{{ port.event.frequency }} Hz
	{%- endmacro %}
	{% macro module_port_label(port, direction) -%}
		{{ direction }}/{{ port.name }}
	{%- endmacro %}

	{% macro build_instance_graph(instance) %}
		// Introduce a core node to anchor left (inputs) -> core -> right (outputs)
		{% set core_id = instance.unique_id ~ '_core' %}
		{% if instance.entity_type == 'module' %}
			subgraph cluster_{{ instance.unique_id }} {
				label="MODULE: {{ instance.name }}";
				style="rounded,filled"; color="{{ instance.color }}"; fillcolor="{{ instance.background_color }}"; fontcolor="{{ instance.text_color }}"; penwidth=1.2; fontsize=40;
				// invisible core anchor node (still used for ordering)
				{{ core_id }} [label="", shape=point, width=0.01, height=0.01, style=invis];
				// left rank (inputs)
				subgraph cluster_{{ instance.unique_id }}_in { label=""; color=none; rank=same;
					{% for p in instance.in_ports %}
						{{ p.unique_id }} [label="{{ module_port_label(p, 'in') }}", shape=ellipse, style=filled, fillcolor="#e0f7ff"];
					{% endfor %}
				}
				// right rank (outputs)
				subgraph cluster_{{ instance.unique_id }}_out { label=""; color=none; rank=same;
					{% for p in instance.out_ports %}
						{{ p.unique_id }} [label="{{ module_port_label(p, 'out') }}", shape=ellipse, style=filled, fillcolor="#fff4e0"];
					{% endfor %}
				}
				// connect in -> core -> out for ordering
				{% for p in instance.in_ports %}
					{{ p.unique_id }} -> {{ core_id }} [arrowhead=none, style=invis, weight=2];
				{% endfor %}
				{% for p in instance.out_ports %}
					{{ core_id }} -> {{ p.unique_id }} [arrowhead=none, style=invis, weight=2];
				{% endfor %}
				// children (nested instances)
				{% for child in instance.children %}
					{{ build_instance_graph(child) }}
				{% endfor %}
				// internal links (true data edges between ports override ordering helpers)
				{% for link in instance.links %}
					{{ link.from_port.unique_id }} -> {{ link.to_port.unique_id }} [color="#555577", arrowhead=normal];
				{% endfor %}
			}
		{% elif instance.entity_type == 'node' %}
			subgraph cluster_{{ instance.unique_id }} {
				label="NODE: {{ instance.name }}";
				style="rounded,filled"; color="{{ instance.color }}"; fillcolor="{{ instance.medium_color }}"; fontcolor="{{ instance.text_color }}"; penwidth=1.5; fontsize=40;
				// invisible core anchor node
				{{ core_id }} [label="", shape=point, width=0.01, height=0.01, style=invis];
				subgraph cluster_{{ instance.unique_id }}_in { label=""; color=none; rank=same;
					{% for p in instance.in_ports %}
						{{ p.unique_id }} [label="{{ node_in_port_label(p, 'in') }}", shape=box, style=filled, fillcolor="#e0f7ff"];
					{% endfor %}
				}
				subgraph cluster_{{ instance.unique_id }}_out { label=""; color=none; rank=same;
					{% for p in instance.out_ports %}
						{{ p.unique_id }} [label="{{ node_out_port_label(p, 'out') }}", shape=box, style=filled, fillcolor="#fff4e0"];
					{% endfor %}
				}
				// ordering edges
				{% for p in instance.in_ports %}
					{{ p.unique_id }} -> {{ core_id }} [arrowhead=none, style=invis, weight=2];
				{% endfor %}
				{% for p in instance.out_ports %}
					{{ core_id }} -> {{ p.unique_id }} [arrowhead=none, style=invis, weight=2];
				{% endfor %}
			}
			// global topics (outside cluster)
			{% for p in instance.out_ports %}
				{% if p.is_global %}
					{{ p.unique_id }}_topic [label="/{{ p.topic | join('/') }}\n@{{ p.event.frequency }}Hz", shape=oval, style=filled, fillcolor="#dddddd", fontsize=8];
					{{ p.unique_id }} -> {{ p.unique_id }}_topic [penwidth=1.2];
				{% endif %}
			{% endfor %}
			{% for p in instance.in_ports %}
				{% if p.is_global %}
					{{ p.unique_id }}_topic [label="/{{ p.topic | join('/') }}", shape=oval, style=filled, fillcolor="#dddddd", fontsize=8];
					{{ p.unique_id }}_topic -> {{ p.unique_id }} [penwidth=1.0, style=solid];
				{% endif %}
			{% endfor %}
		{% endif %}
	{% endmacro %}

	// Top-level children clusters
	{% for child in children %}
		{{ build_instance_graph(child) }}
	{% endfor %}

	// Cross-instance links (already included in module internal links, but top-level may add more)
	{% for link in links %}
		{{ link.from_port.unique_id }} -> {{ link.to_port.unique_id }};
	{% endfor %}

	// Hidden edges to stabilize layout horizontally (use invisible core nodes for alignment)
	{% for i in range(children|length) %}
		{% set ci = children[i].unique_id + '_core' %}
		{% for j in range(i + 1, children|length) %}
			{% set cj = children[j].unique_id + '_core' %}
			{{ ci }} -> {{ cj }} [style=invis, weight=0];
		{% endfor %}
	{% endfor %}
}
