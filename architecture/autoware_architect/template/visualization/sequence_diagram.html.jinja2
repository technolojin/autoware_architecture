<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>System Diagram {{ name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #header {
            padding: 10px 20px;
            background: #ffffff;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }
        h1 { margin: 0; font-size: 18px; color: #212529; }
        #mode-selector {
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 20px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        #canvas-container {
            flex-grow: 1;
            background: #ffffff;
            overflow: hidden;
            position: relative;
            cursor: grab;
        }
        #canvas-container:active {
            cursor: grabbing;
        }
        
        .mermaid {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Ensure SVG fills container for pan-zoom */
        .mermaid svg {
            height: 100%;
            width: 100%;
        }

        /* Loading overlay */
        #loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            font-size: 18px; color: #495057;
            z-index: 100;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d6efd;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Interaction styles */
        /* High specificity to override default and hover styles */
        .mermaid .active-connection, .mermaid .active-connection:hover {
            stroke-width: 7px !important;
            stroke: #dc3545 !important; /* Red/Pink highlight */
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
            stroke-dasharray: none !important;
        }
        /* Pointer cursor for interactive elements */
        g [class^="messageLine"], g [class^="messageText"] {
            cursor: pointer !important;
            pointer-events: all; /* Ensure clicks are captured */
        }
        /* Thicker lines for better visibility/clicking, but lighter color */
        g [class^="messageLine"] {
            stroke-width: 6px !important;
            stroke: #888 !important;
        }
        /* Hover hint */
        g [class^="messageLine"]:hover {
            stroke: #555 !important;
            stroke-width: 7px !important; 
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">Rendering Diagram...</div>
    </div>

    <div id="header">
        <h1>System Diagram: {{ name }}</h1>
        <div id="controls" style="display: flex; align-items: center; gap: 10px;">
            <label for="mode-selector" style="color: #495057; font-weight: 500;">View Mode:</label>
            <select id="mode-selector">
                {% for mode in modes %}
                <option value="{{ mode }}" {% if mode == default_mode %}selected{% endif %}>{{ mode }}</option>
                {% endfor %}
            </select>
            <button onclick="resetZoom()" style="padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Reset Zoom</button>
        </div>
    </div>
    
    <div id="canvas-container">
        <div class="mermaid" id="mermaid-container"></div>
    </div>

    <script>
        let panZoomInstance = null;
        const selector = document.getElementById('mode-selector');
        const mermaidContainer = document.getElementById('mermaid-container');
        const loading = document.getElementById('loading');

        function showLoading(show, text) {
            loading.style.display = show ? 'flex' : 'none';
            if (text) document.getElementById('loading-text').innerText = text;
        }

        function resetZoom() {
            if (panZoomInstance) {
                panZoomInstance.reset();
                panZoomInstance.center();
            }
        }

        async function renderSequenceDiagram(mermaidSyntax) {
            showLoading(true, "Rendering Diagram...");
            
            // Clear previous content
            mermaidContainer.innerHTML = '';
            
            // Destroy previous pan-zoom instance if it exists
            if (panZoomInstance) {
                panZoomInstance.destroy();
                panZoomInstance = null;
            }

            try {
                // Create a unique ID for this diagram
                const diagramId = 'sequence-diagram-' + Date.now();
                mermaidContainer.id = diagramId;
                mermaidContainer.innerHTML = mermaidSyntax;

                // Render with Mermaid
                await mermaid.run({
                    nodes: [mermaidContainer]
                });
                
                const svgElement = document.querySelector('.mermaid svg');
                if (svgElement) {
                    // Remove max-width to allow scaling
                    svgElement.style.maxWidth = 'none';
                    svgElement.style.height = '100%';
                    svgElement.style.width = '100%';
                    
                    // Add interaction: Highlight connection on click
                    svgElement.addEventListener('click', (e) => {
                        let target = e.target;
                        let lineElement = null;

                        // Helper to check if element is a visible message line
                        const isLine = (el) => {
                            if (!el || !el.getAttribute) return false;
                            const cls = el.getAttribute('class') || '';
                            return cls.includes('messageLine');
                        };

                        // 1. Check if clicked element is the line itself
                        if (target.tagName === 'path' || target.tagName === 'line') {
                            if (isLine(target)) {
                                lineElement = target;
                            }
                        } 
                        // 2. Check if clicked element is text
                        else if (target.tagName === 'text' || target.tagName === 'tspan') {
                            // If text is clicked, find the associated message line.
                            const textEl = target.closest('text');
                            if (textEl && (textEl.getAttribute('class') || '').includes('messageText')) {
                                let next = textEl.nextElementSibling;
                                while (next) {
                                    // If we find a line, that's our target
                                    if (isLine(next)) {
                                        lineElement = next;
                                        break;
                                    }
                                    // If we hit another text, we've likely gone too far
                                    if (next.tagName === 'text' && (next.getAttribute('class') || '').includes('messageText')) {
                                        break; 
                                    }
                                    next = next.nextElementSibling;
                                }
                            }
                        }

                        if (lineElement) {
                            // Remove existing highlights
                            svgElement.querySelectorAll('.active-connection').forEach(el => {
                                if (el !== lineElement) el.classList.remove('active-connection');
                            });
                            // Toggle highlight
                            lineElement.classList.toggle('active-connection');
                            e.stopPropagation(); // Prevent other handlers
                        } else {
                            // Clicked background, clear highlights
                            svgElement.querySelectorAll('.active-connection').forEach(el => {
                                el.classList.remove('active-connection');
                            });
                        }
                    });

                    // Initialize Pan Zoom
                    panZoomInstance = svgPanZoom(svgElement, {
                        zoomEnabled: true,
                        controlIconsEnabled: false,
                        fit: true,
                        center: true,
                        minZoom: 0.5,
                        maxZoom: 50,
                        zoomScaleSensitivity: 0.4,
                        dblClickZoomEnabled: false // Conflicts with some user interactions
                    });
                    
                    // Initial Fit
                    panZoomInstance.resize();
                    panZoomInstance.fit();
                    panZoomInstance.center();
                }
            } catch (e) {
                console.error("Mermaid rendering failed:", e);
                alert("Error rendering sequence diagram: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        function loadMode(mode) {
            showLoading(true, "Loading Data...");
            
            const initData = () => {
                if (window.sequenceDiagramData && window.sequenceDiagramData[mode]) {
                    const mermaidSyntax = window.sequenceDiagramData[mode];
                    renderSequenceDiagram(mermaidSyntax);
                } else {
                    alert("Failed to load data for mode: " + mode);
                    showLoading(false);
                }
            };

            if (window.sequenceDiagramData && window.sequenceDiagramData[mode]) {
                initData();
                return;
            }
            
            const script = document.createElement('script');
            script.src = `data/${mode}_sequence_diagram.js`;
            script.onload = initData;
            script.onerror = function(e) {
                showLoading(false);
                alert("Error loading script for mode: " + mode);
            };
            document.body.appendChild(script);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose',
                sequence: {
                    showSequenceNumbers: false,
                    useMaxWidth: false,
                    mirrorActors: true,
                    bottomMarginAdj: 10,
                    messageAlign: 'center'
                }
            });
            
            // Load initial mode
            loadMode(selector.value);
            
            // Handle mode change
            selector.addEventListener('change', function(e) {
                loadMode(e.target.value);
            });
        });
    </script>
</body>
</html>