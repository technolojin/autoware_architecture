<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Autoware Architecture Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://unpkg.com/klayjs@0.4.1/klay.js"></script>
    <script src="https://unpkg.com/cytoscape-klay@3.1.4/cytoscape-klay.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }
        #sidebar {
            width: 300px;
            background: #f4f4f4;
            border-right: 1px solid #ddd;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            z-index: 2;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #mode-selector {
            padding: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            width: 100%;
        }
        #info-panel {
            flex-grow: 1;
            overflow-y: auto;
        }
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        .info-title { font-weight: bold; margin-bottom: 5px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .info-row { margin-bottom: 3px; font-size: 13px; }
        .info-label { color: #666; font-size: 12px; }
        .info-value { color: #000; font-family: monospace; }
        
        #cy {
            flex-grow: 1;
            background: white;
            z-index: 1;
        }
        
        /* Loading overlay */
        #loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #666;
            z-index: 100;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="sidebar">
        <h2>Architecture</h2>
        <label for="mode-selector">Mode:</label>
        <select id="mode-selector">
            {% for mode in modes %}
            <option value="{{ mode }}" {% if mode == default_mode %}selected{% endif %}>{{ mode }}</option>
            {% endfor %}
        </select>
        
        <div id="info-panel">
            <div class="info-card">
                <div class="info-row">Select a node or edge to see details.</div>
            </div>
        </div>
    </div>
    <div id="cy"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize klay layout extension if available
            if (typeof cytoscape !== 'undefined' && typeof cytoscapeKlay !== 'undefined') {
                try {
                    cytoscape.use(cytoscapeKlay);
                    console.log("Registered klay layout");
                } catch(e) {
                    console.warn("Could not register klay layout via .use()", e);
                    try {
                         cytoscape('layout', 'klay', cytoscapeKlay);
                    } catch(e2) {
                        console.warn("Could not register klay layout via legacy method", e2);
                    }
                }
            } else {
                 console.warn("Cytoscape or cytoscape-klay not found globally");
            }
            
            const selector = document.getElementById('mode-selector');
            const infoPanel = document.getElementById('info-panel');
            const loading = document.getElementById('loading');
            
            let cy = null;

            function showLoading(show) {
                loading.style.display = show ? 'flex' : 'none';
            }

            function updateInfo(data, type) {
                let html = `<div class="info-card"><div class="info-title">${type} Details</div>`;
                
                for (const [key, value] of Object.entries(data)) {
                    if (['id', 'parent', 'source', 'target', 'color', 'backgroundColor', 'label'].includes(key)) continue;
                    if (typeof value === 'object' && value !== null) continue; // Skip complex objects
                    
                    html += `<div class="info-row">
                        <span class="info-label">${key}:</span> 
                        <span class="info-value">${value}</span>
                    </div>`;
                }
                html += '</div>';
                infoPanel.innerHTML = html;
            }

            function transformDataToElements(root) {
                const elements = [];
                
                function getPortLabel(port) {
                    let parts = [];
                    if (port.name) parts.push(port.name);
                    
                    // Add topic if available
                    if (port.topic) {
                        const topics = Array.isArray(port.topic) ? port.topic.join(', ') : port.topic;
                        if (topics) parts.push(topics);
                    }
                    // Add type if available
                    if (port.msg_type) {
                        parts.push(port.msg_type);
                    }
                    // Add frequency if available
                    if (port.event && port.event.frequency) {
                        parts.push('@' + port.event.frequency + ' Hz');
                    }
                    return parts.join('\n');
                }

                function traverse(instance, parentId) {
                    const nodeId = instance.unique_id;
                    
                    // Node for the instance
                    elements.push({
                        data: { 
                            id: nodeId, 
                            label: instance.name, 
                            parent: parentId,
                            type: instance.entity_type,
                            color: instance.color,
                            backgroundColor: instance.background_color,
                            textColor: instance.text_color,
                            ...instance
                        },
                        classes: instance.entity_type || 'unknown'
                    });

                    // Ports as nodes
                    if (instance.in_ports && Array.isArray(instance.in_ports)) {
                        instance.in_ports.forEach(port => {
                            elements.push({
                                data: { 
                                    id: port.unique_id, 
                                    parent: nodeId, 
                                    label: getPortLabel(port), 
                                    type: 'port',
                                    side: 'in',
                                    portConstraints: {
                                        fixedSide: 'WEST'
                                    },
                                    ...port 
                                },
                                classes: 'port in-port'
                            });
                        });
                    }
                    
                    if (instance.out_ports && Array.isArray(instance.out_ports)) {
                        instance.out_ports.forEach(port => {
                            elements.push({
                                data: { 
                                    id: port.unique_id, 
                                    parent: nodeId, 
                                    label: getPortLabel(port), 
                                    type: 'port',
                                    side: 'out',
                                    portConstraints: {
                                        fixedSide: 'EAST'
                                    },
                                    ...port 
                                },
                                classes: 'port out-port'
                            });
                        });
                    }

                    // Recursion
                    if (instance.children && Array.isArray(instance.children)) {
                        instance.children.forEach(child => traverse(child, nodeId));
                    }
                    
                    // Links
                    if (instance.links && Array.isArray(instance.links)) {
                        instance.links.forEach(link => {
                            elements.push({
                                data: {
                                    source: link.from_port.unique_id,
                                    target: link.to_port.unique_id,
                                    msg_type: link.msg_type,
                                    ...link
                                },
                                classes: 'link'
                            });
                        });
                    }
                }
                
                traverse(root, null);
                return elements;
            }

            function loadMode(mode) {
                showLoading(true);
                
                // Function to initialize once data is available
                const initData = () => {
                    if (window.architectureData && window.architectureData[mode]) {
                        try {
                            const elements = transformDataToElements(window.architectureData[mode]);
                            initCytoscape(elements);
                        } catch(e) {
                            console.error(e);
                            alert("Error processing data: " + (e.message || e));
                            console.error(e.stack);
                        }
                    } else {
                        alert("Failed to load data for mode: " + mode);
                    }
                    showLoading(false);
                };

                // Check if already loaded
                if (window.architectureData && window.architectureData[mode]) {
                    initData();
                    return;
                }
                
                // Load script dynamically
                const script = document.createElement('script');
                script.src = `data/${mode}.js`;
                script.onload = initData;
                script.onerror = function(e) {
                    showLoading(false);
                    console.error(e);
                    alert("Error loading script for mode: " + mode);
                };
                document.body.appendChild(script);
            }

            function initCytoscape(elements) {
                if (cy) cy.destroy();
                
                // Default layout options (klay)
                let layoutOptions = {
                    name: 'klay',
                    nodeDimensionsIncludeLabels: true,
                    fit: true,
                    padding: 20,
                    animate: false,
                    klay: {
                        addUnnecessaryBendpoints: false,
                        aspectRatio: 1.6,
                        borderSpacing: 20,
                        compactComponents: false,
                        crossingMinimization: 'LAYER_SWEEP',
                        cycleBreaking: 'GREEDY',
                        direction: 'RIGHT',
                        edgeRouting: 'ORTHOGONAL',
                        edgeSpacingFactor: 0.5,
                        feedbackEdges: true,
                        fixedAlignment: 'BALANCED',
                        inLayerSpacingFactor: 1.0,
                        layoutHierarchy: true,
                        linearSegmentsDeflectionDampening: 0.3,
                        mergeEdges: false,
                        mergeHierarchyCrossingEdges: true,
                        nodeLayering: 'NETWORK_SIMPLEX',
                        nodePlacement: 'BRANDES_KOEPF',
                        randomizationSeed: 1,
                        routeSelfLoopInside: false,
                        separateConnectedComponents: true,
                        spacing: 40,
                        thoroughness: 7
                    }
                };
                
                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    boxSelectionEnabled: false,
                    autoungrabify: true,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'font-size': '10px',
                                'color': '#333',
                                'background-color': '#ddd',
                                'border-width': 1,
                                'border-color': '#999'
                            }
                        },
                        {
                            selector: '.module',
                            style: {
                                'background-color': 'data(backgroundColor)',
                                'color': 'data(textColor)',
                                'border-width': 2,
                                'border-color': 'data(color)',
                                'text-valign': 'top',
                                'padding': '20px',
                                'font-size': '14px',
                                'font-weight': 'bold'
                            }
                        },
                        {
                            selector: '.node', // Entity type 'node'
                            style: {
                                'background-color': 'data(medium_color)',
                                'shape': 'rectangle',
                                'width': 'label',
                                'height': 'label',
                                'padding': '10px'
                            }
                        },
                        {
                            selector: '.port',
                            style: {
                                'width': 'label',
                                'height': 'label',
                                'shape': 'roundrectangle',
                                'background-color': '#888',
                                'label': 'data(label)',
                                'text-wrap': 'wrap',
                                'text-max-width': '200px',
                                'font-size': '8px',
                                'border-width': 1,
                                'border-color': '#555',
                                'padding': '5px'
                            }
                        },
                        {
                            selector: '.in-port',
                            style: { 'background-color': '#e0f7ff' }
                        },
                        {
                            selector: '.out-port',
                            style: { 'background-color': '#fff4e0' }
                        },
                        {
                            selector: '.structural-node',
                            style: {
                                'width': 1,
                                'height': 1,
                                'visibility': 'hidden',
                                'opacity': 0
                            }
                        },
                        {
                            selector: '.structural-edge',
                            style: {
                                'width': 0,
                                'visibility': 'hidden',
                                'opacity': 0
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 1,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'taxi',
                                'taxi-direction': 'horizontal'
                            }
                        },
                        {
                            selector: 'edge.highlighted',
                            style: {
                                'line-color': '#007bff',
                                'target-arrow-color': '#007bff',
                                'width': 3
                            }
                        },
                        {
                            selector: 'node.highlighted',
                            style: {
                                'border-color': '#007bff',
                                'border-width': 3
                            }
                        }
                    ],
                    layout: layoutOptions
                });
                
                // Event handling
                cy.on('tap', 'node', function(evt){
                    const node = evt.target;
                    if (node.hasClass('structural-node')) return;
                    updateInfo(node.data(), 'Node');
                    
                    // Highlight connected
                    cy.elements().removeClass('highlighted');
                    node.neighborhood().addClass('highlighted');
                    node.addClass('highlighted');
                });
                
                cy.on('tap', 'edge', function(evt){
                    const edge = evt.target;
                    if (edge.hasClass('structural-edge')) return;
                    updateInfo(edge.data(), 'Link');
                    
                    cy.elements().removeClass('highlighted');
                    edge.addClass('highlighted');
                    edge.source().addClass('highlighted');
                    edge.target().addClass('highlighted');
                });
                
                cy.on('tap', function(evt){
                    if(evt.target === cy){
                        cy.elements().removeClass('highlighted');
                        infoPanel.innerHTML = '<div class="info-card"><div class="info-row">Select a node or edge to see details.</div></div>';
                    }
                });

                // Manual panning implementation for ungrabbable nodes/edges
                let dragStartPos = null;
                let dragStartPan = null;

                cy.on('tapstart', 'node, edge', function(evt) {
                    dragStartPos = { ...evt.renderedPosition };
                    dragStartPan = { ...cy.pan() };
                });

                cy.on('tapdrag', function(evt) {
                    if (dragStartPos) {
                        const currentPos = evt.renderedPosition;
                        const dx = currentPos.x - dragStartPos.x;
                        const dy = currentPos.y - dragStartPos.y;
                        
                        cy.pan({
                            x: dragStartPan.x + dx,
                            y: dragStartPan.y + dy
                        });
                    }
                });

                cy.on('tapend', function() {
                    dragStartPos = null;
                    dragStartPan = null;
                });
            }

            // Initial load
            loadMode(selector.value);
            
            selector.addEventListener('change', function(e) {
                loadMode(e.target.value);
            });
        });
    </script>
</body>
</html>